import { NextRequest, NextResponse } from "next/server";

export async function POST(request: NextRequest) {
  try {
    const { category, topic } = await request.json();

    // Use Hack Club AI (free, no API key needed)
    const prompt = generatePrompt(category, topic);

    console.log("Making Hack Club AI API call with prompt:", prompt);

    const response = await fetch("https://ai.hackclub.com/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        messages: [
          {
            role: "system",
            content:
              "You are a creative joke generator. Your task is to create ORIGINAL, funny jokes from scratch based on the user's prompt. Do NOT use templates or pre-written jokes. Create something genuinely new and creative. Keep jokes family-friendly, under 100 words, and actually funny. Respond with just the joke, no explanations.",
          },
          {
            role: "user",
            content: prompt,
          },
        ],
        max_tokens: 200,
        temperature: 0.9,
      }),
    });

    console.log("Hack Club AI response status:", response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error("Hack Club AI error response:", errorText);
      throw new Error(`Hack Club AI error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    console.log("Hack Club AI response data:", data);

    const aiJoke = data.choices[0]?.message?.content?.trim();

    if (!aiJoke) {
      throw new Error("No joke generated by AI");
    }

    return NextResponse.json({
      joke: aiJoke,
      category,
      topic,
    });
  } catch (error) {
    console.error("Error generating joke:", error);
    // Fallback to mock AI if real AI fails
    return generateMockJoke(category, topic);
  }
}

function generatePrompt(category: string, topic: string): string {
  // Create a direct, simple prompt that asks AI to generate a joke from scratch
  const basePrompt = `Create a funny, original joke about "${topic}". 
  
Requirements:
- Make it genuinely creative and original
- Keep it family-friendly and appropriate
- Make it specific to the topic provided
- Use wordplay, puns, or clever observations
- Keep it under 100 words
- Make it actually funny and entertaining

Just provide the joke directly, no explanations.`;

  // Add category-specific context if needed
  const categoryContext = {
    people: `Focus on the person's name, job, or personality traits.`,
    animals: `Make it about the animal's behavior, characteristics, or habits.`,
    food: `Use food-related wordplay, cooking, or eating scenarios.`,
    science: `Include scientific concepts, technology, or educational humor.`,
    school: `Reference learning, education, teachers, or school life.`,
    work: `Use workplace scenarios, office humor, or professional situations.`,
    health: `Reference medicine, doctors, health, or wellness topics.`,
    sports: `Use sports terminology, athletic scenarios, or game situations.`,
    travel: `Reference travel, transportation, or vacation scenarios.`,
    music: `Use musical terms, instruments, or performance scenarios.`,
    weather: `Reference weather, nature, or environmental topics.`,
    money: `Use financial terms, business scenarios, or economic humor.`,
    relationships: `Focus on dating, friendship, or relationship dynamics.`,
    language: `Use wordplay, puns, or linguistic humor.`,
    time: `Reference time, schedules, calendars, or temporal concepts.`,
    general: `Be creative and original with the topic.`,
  };

  const context =
    categoryContext[category as keyof typeof categoryContext] ||
    categoryContext.general;

  return `${basePrompt}\n\nContext: ${context}`;
}

function generateMockJoke(category: string, topic: string) {
  const mockAIJokes = {
    people: [
      `Why did ${topic.split(",")[0]} go to the doctor? Because they needed a check-up!`,
      `What do you call ${topic.split(",")[0]}? A real character!`,
      `Why did ${topic.split(",")[0]} cross the road? To get to the punchline!`,
    ],
    animals: [
      `Why did the ${topic} go to the doctor? Because it was feeling a bit under the weather!`,
      `What do you call a ${topic} that sings? A musical ${topic}!`,
      `Why did the ${topic} join a band? Because it had the talent!`,
    ],
    food: [
      `Why did the ${topic} go to the party? Because it was the life of the dish!`,
      `What do you call a ${topic} that's always late? A procrastinating ${topic}!`,
      `Why did the ${topic} go to school? To get smarter!`,
    ],
    science: [
      `Why did the ${topic} go to space? Because it wanted to explore the universe!`,
      `What do you call a ${topic} that's always learning? A curious ${topic}!`,
      `Why did the ${topic} become a scientist? Because it loved experiments!`,
    ],
    general: [
      `Why did the ${topic} go on vacation? Because it needed a break!`,
      `What do you call a ${topic} that's always happy? A cheerful ${topic}!`,
      `Why did the ${topic} go to the gym? To get stronger!`,
    ],
  };

  const categoryJokes =
    mockAIJokes[category as keyof typeof mockAIJokes] || mockAIJokes.general;
  const randomJoke =
    categoryJokes[Math.floor(Math.random() * categoryJokes.length)];

  return NextResponse.json({
    joke: randomJoke,
    category,
    topic,
  });
}
